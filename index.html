<!DOCTYPE html>
<html>
<head>
  <title>Electron WebRTC App</title>
  
</head>

<body>
  <h1>WebRTC Video Chat</h1>
  <button id="start-call">Start Call</button>
  <div id="local-video-container">
    <video id="local-video" autoplay playsinline></video>
  </div>
  <div id="remote-video-container">
    <video id="remote-video" autoplay playsinline></video>
  </div>

  <div id="error-message" style="color: rgb(0, 255, 86);"></div>

  <script nonce="nonce-string">
   
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const startCallButton = document.getElementById('start-call');
    const errorMessage = document.getElementById('error-message');
    let localStream;
    let peerConnection;

    startCallButton.addEventListener('click', async () => {
      startCallButton.disabled = true;
      errorMessage.textContent = '';

      try {
        // Request permission to access the camera
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localStream = stream
        localVideo.srcObject = stream;
    
        createPeerConnection(stream);
      } catch (err) {
        console.error('Error accessing camera and microphone:', err);
      }
    });

    function createPeerConnection(stream) {
      peerConnection = new RTCPeerConnection();

      stream.getTracks().forEach(track => {
        peerConnection.addTrack(track, stream);
      });

      peerConnection.onicecandidate = event => {
        console.log("ice candidate event")
        if (event.candidate) {
          console.log("Sending ice candidate to node process")
          window.ipcRenderer.send("on-ice-candidate", event.candidate)
        }
      };

      console.log("Sending create peer candidate to node process")
      window.ipcRenderer.send('create-peer-connection')
    }

    window.ipcRenderer.on('on-signal-server-message', async (message) => {
      console.log("Received signal server event")
      if (message.sdp) {
        try {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(message.message.sdp));
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);

          window.ipcRenderer.send('publish-answer', answer)
        } catch (err) {
          console.error('Error setting or creating session description:', err);
        }
      } else if (message.iceCandidate) {
        if (peerConnection) {
          try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(message.iceCandidate));
          } catch (err) {
            console.error('Error adding ICE candidate:', err);
          }
        }
      } else if (message.remoteStream) {
        remoteVideo.srcObject = stream;
      }
    })
  </script>
</body>
</html>



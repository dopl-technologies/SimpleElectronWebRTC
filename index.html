<!DOCTYPE html>
<html>
<head>
  <title>Electron WebRTC App</title>
  
</head>

<body>
  <script src="render.js"></script>

  <h1>WebRTC Video Chat</h1>
  <button id="start-call">Start Call</button>
  <div id="local-video-container">
    <video id="local-video" autoplay playsinline></video>
  </div>
  <div id="remote-video-container">
    <video id="remote-video" autoplay playsinline></video>
  </div>

  <div id="error-message" style="color: rgb(0, 255, 86);"></div>

  <script nonce="nonce-string">
   
const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const startCallButton = document.getElementById('start-call');
    const errorMessage = document.getElementById('error-message');
    let localStream;

    startCallButton.addEventListener('click', async () => {
      startCallButton.disabled = true;
      errorMessage.textContent = '';

      try {
        // Request permission to access the camera
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localStream = stream
        localVideo.srcObject = stream;
    
        console.log("Ignoring creating a peer connection for now")
        //createPeerConnection();
      } catch (err) {
        console.error('Error accessing camera and microphone:', err);
      }
    });

    function createPeerConnection() {
      peerConnection = new RTCPeerConnection();

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          // pubnub.publish({
          //   channel: 'webrtc',
          //   message: { iceCandidate: event.candidate },
          // });
          window.ipcRenderer.send("on-ice-candidate", event.candidate)
        }
      };

      pubnub.addListener({
        message: async message => {
          if (message.message.sdp) {
            try {
              await peerConnection.setRemoteDescription(new RTCSessionDescription(message.message.sdp));
              const answer = await peerConnection.createAnswer();
              await peerConnection.setLocalDescription(answer);

              pubnub.publish({
                channel: 'webrtc',
                message: { sdp: answer },
              });
            } catch (err) {
              console.error('Error setting or creating session description:', err);
            }
          } else if (message.message.iceCandidate) {
            if (peerConnection) {
              try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.message.iceCandidate));
              } catch (err) {
                console.error('Error adding ICE candidate:', err);
              }
            }
          } else if (message.message.remoteStream) {
            mainWindow.webContents.send('remote-video', message.message.remoteStream);
          }
        },
      });
    }

    // window.ipcRenderer.on('local-video', (event, stream) => {
    //   localVideo.srcObject = stream;
    // });

    window.ipcRenderer.on('remote-video', (event, stream) => {
      remoteVideo.srcObject = stream;
    });

    window.ipcRenderer.on('error', (event, message) => {
      errorMessage.textContent = message;
    });
  </script>
</body>
</html>


